<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call Simulator</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2em;
      color: #444;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    #transcript, #ai-response {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 15px 0;
      min-height: 60px;
      text-align: left;
      background: #fefefe;
      border-radius: 8px;
      overflow-y: auto;
    }

    button {
      padding: 12px 20px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #start-btn { background-color: #4CAF50; color: white; }
    #send-btn { background-color: #2196F3; color: white; }

    #loader {
      display: none;
      margin: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Call Simulator üéß</h1>
    <button id="start-btn">üé§ Start Listening</button>
    <button id="send-btn" disabled>‚úâÔ∏è Send</button>
    <div id="loader">‚è≥ AI is thinking...</div>

    <h3>You Said:</h3>
    <div id="transcript">‚Äî</div>

    <h3>Customer (AI) Said:</h3>
    <div id="ai-response">‚Äî</div>
  </div>

  <script>
    const WORKER_URL = 'https://workers-playground-tiny-sky-5f02.amrassal91.workers.dev';

    const startBtn = document.getElementById('start-btn');
    const sendBtn = document.getElementById('send-btn');
    const loader = document.getElementById('loader');
    const transcriptEl = document.getElementById('transcript');
    const aiResponseEl = document.getElementById('ai-response');

    let recognition, finalTranscript = '', isRecognizing = false;

    function initRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        alert('Speech recognition not supported.');
        return null;
      }
      const rec = new SR();
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.continuous = true;

      rec.onstart = () => {
        isRecognizing = true;
        startBtn.textContent = 'üõë Stop';
        transcriptEl.textContent = 'Listening...';
      };

      rec.onresult = e => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalTranscript += t + ' ';
          else interim += t;
        }
        transcriptEl.textContent = finalTranscript + interim;
        sendBtn.disabled = !finalTranscript.trim();
      };

      rec.onerror = e => {
        console.error('Speech error:', e.error);
        transcriptEl.textContent = 'Error: ' + e.error;
        stopRec();
      };

      rec.onend = () => {
        isRecognizing = false;
        startBtn.textContent = 'üé§ Start Listening';
      };

      return rec;
    }

    function startRec() {
      if (!recognition) recognition = initRecognition();
      finalTranscript = '';
      transcriptEl.textContent = '';
      sendBtn.disabled = true;
      recognition.start();
    }

    function stopRec() {
      if (recognition && isRecognizing) recognition.stop();
    }

    startBtn.addEventListener('click', () => {
      isRecognizing ? stopRec() : startRec();
    });

    sendBtn.addEventListener('click', async () => {
      stopRec();
      sendBtn.disabled = true;
      loader.style.display = 'block';
      aiResponseEl.textContent = '';

      try {
        const payload = { contents: [{ parts: [{ text: finalTranscript.trim() }] }] };
        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '(No response)';
        aiResponseEl.textContent = reply;
        speak(reply);
      } catch (e) {
        aiResponseEl.textContent = 'AI Error: ' + e.message;
        console.error('Fetch failed:', e);
      } finally {
        loader.style.display = 'none';
      }
    });

    function speak(text) {
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      window.speechSynthesis.speak(utter);
    }
  </script>
</body>
</html>
