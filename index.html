<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Call Simulator</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .header {
      background: #0078D4;
      color: white;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 80%;
      padding: 0.8rem 1rem;
      border-radius: 1rem;
      position: relative;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: #0078D4;
      color: white;
      border-bottom-right-radius: 0.3rem;
    }

    .message.ai {
      align-self: flex-start;
      background: #f0f0f0;
      color: #000;
      border-bottom-left-radius: 0.3rem;
    }

    .controls {
      padding: 1rem;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .button-group {
      display: flex;
      gap: 0.8rem;
      justify-content: center;
    }

    .control-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 8px;
      background: #0078D4;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .control-button:hover:not(:disabled) {
      background: #006cbd;
    }

    .control-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .control-button .button-icon {
      font-size: 1.2rem;
    }

    .record-button {
      background: #4CAF50;
    }

    .record-button:hover:not(:disabled) {
      background: #43a047;
    }

    .record-button.recording {
      background: #d32f2f;
      animation: pulse 1.5s infinite;
    }

    .cancel-button {
      background: #f44336;
    }

    .cancel-button:hover:not(:disabled) {
      background: #e53935;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
      100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
    }

    .mic-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      flex: 1;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }

    #loader {
      display: none;
      color: #0078D4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Call Simulator üéß</h1>
    </div>
    <div class="chat-container" id="chat">
      <div class="message ai">Hi! Click the microphone button and start talking. Say "send" when you're done or "delete" to cancel.</div>
    </div>
    <div class="controls">
      <div class="button-group">
        <button class="control-button record-button" id="mic-btn" title="Start/Stop recording">
          <span class="button-icon">üé§</span>
          <span class="button-text">Hold to Talk</span>
        </button>
        <button class="control-button send-button" id="send-btn" disabled title="Send message">
          <span class="button-icon">üì§</span>
          <span class="button-text">Send</span>
        </button>
        <button class="control-button cancel-button" id="cancel-btn" disabled title="Cancel recording">
          <span class="button-icon">‚ùå</span>
          <span class="button-text">Cancel</span>
        </button>
      </div>
      <div class="status-bar">
        <div class="status" id="status">Click microphone to start</div>
        <div id="loader">‚è≥ Processing...</div>
      </div>
    </div>
  </div>

  <script>
    // Initialize voices as soon as possible
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices(); // Cache the voices
      };
    }

    const WORKER_URL = 'https://workers-playground-tiny-sky-5f02.amrassal91.workers.dev';
    
    const micBtn = document.getElementById('mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const chat = document.getElementById('chat');
    const status = document.getElementById('status');
    const loader = document.getElementById('loader');

    let recognition;
    let isRecognizing = false;
    let currentTranscript = '';
    let finalTranscript = '';

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function initRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        alert('Speech recognition not supported in this browser.');
        return null;
      }

      const rec = new SR();
      rec.lang = 'en-US';
      rec.continuous = true;
      rec.interimResults = true;

      rec.onstart = () => {
        isRecognizing = true;
        micBtn.classList.add('recording');
        sendBtn.disabled = true;
        cancelBtn.disabled = false;
        status.textContent = 'Listening...';
        currentTranscript = '';
        finalTranscript = '';
      };

      rec.onresult = (e) => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const transcript = e.results[i][0].transcript.trim();
          if (e.results[i].isFinal) {
            finalTranscript = transcript;
            
            // Check for voice commands
            const command = transcript.toLowerCase();
            if (command === 'send' || command.endsWith(' send')) {
              if (currentTranscript) {
                sendMessage(currentTranscript);
              }
              return;
            } else if (command === 'delete' || command.endsWith(' delete')) {
              currentTranscript = '';
              const messages = chat.getElementsByClassName('message user');
              if (messages.length > 0) {
                chat.removeChild(messages[messages.length - 1]);
              }
              return;
            }
            
            currentTranscript = transcript;
            sendBtn.disabled = false;
          } else {
            interim = transcript;
          }
        }

        // Update the display
        const displayText = interim || currentTranscript;
        const messages = chat.getElementsByClassName('message user');
        if (messages.length > 0 && !messages[messages.length - 1].classList.contains('sent')) {
          messages[messages.length - 1].textContent = displayText;
        } else {
          addMessage(displayText, 'user');
        }
      };

      rec.onerror = (e) => {
        console.error('Speech recognition error:', e.error);
        if (e.error === 'network') {
          status.textContent = 'Network error. Retrying...';
          setTimeout(() => {
            if (isRecognizing) startRecognition();
          }, 1000);
        } else {
          status.textContent = `Error: ${e.error}`;
          stopRecognition();
        }
      };

      rec.onend = () => {
        isRecognizing = false;
        micBtn.classList.remove('recording');
        cancelBtn.disabled = true;
        status.textContent = 'Click mic to start';
      };

      return rec;
    }

    function startRecognition() {
      if (!recognition) recognition = initRecognition();
      try {
        recognition.start();
      } catch (e) {
        console.error('Failed to start recognition:', e);
        status.textContent = 'Failed to access microphone';
      }
    }

    function stopRecognition() {
      if (recognition && isRecognizing) {
        recognition.stop();
      }
    }

    async function sendMessage(text) {
      if (!text) return;
      
      // Mark the last user message as sent
      const messages = chat.getElementsByClassName('message user');
      if (messages.length > 0) {
        messages[messages.length - 1].classList.add('sent');
      }

      // Stop recognition while processing
      stopRecognition();
      
      loader.style.display = 'block';
      status.textContent = 'Processing...';

      try {
        const payload = { contents: [{ parts: [{ text }] }] };
        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || '(No response)';
        
        addMessage(reply, 'ai');
        speak(reply);
      } catch (e) {
        console.error('API Error:', e);
        addMessage('Sorry, I encountered an error processing your message.', 'ai');
      } finally {
        loader.style.display = 'none';
        status.textContent = 'Click mic to start';
        currentTranscript = '';
        // Restart recognition after processing
        startRecognition();
      }
    }

    function speak(text) {
      if (!window.speechSynthesis) return;
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      
      // Try to find a pleasant voice (Microsoft Zira or similar)
      const voices = window.speechSynthesis.getVoices();
      const preferredVoice = voices.find(voice => 
        voice.name.includes('Zira') || 
        voice.name.includes('Samantha') ||
        (voice.name.includes('Female') && voice.lang.includes('en-US'))
      );
      
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }
      
      // Adjust voice parameters for better quality
      utterance.pitch = 1.0;  // Normal pitch
      utterance.rate = 0.9;   // Slightly slower for clarity
      utterance.volume = 1.0; // Full volume
      
      // Stop recognition while speaking to prevent feedback
      stopRecognition();
      
      utterance.onend = () => {
        // Restart recognition after speaking
        startRecognition();
      };
      
      window.speechSynthesis.speak(utterance);
    }

    micBtn.addEventListener('click', () => {
      if (isRecognizing) {
        stopRecognition();
      } else {
        startRecognition();
      }
    });

    sendBtn.addEventListener('click', () => {
      if (currentTranscript.trim()) {
        sendMessage(currentTranscript.trim());
      }
    });

    cancelBtn.addEventListener('click', () => {
      currentTranscript = '';
      const messages = chat.getElementsByClassName('message user');
      if (messages.length > 0) {
        chat.removeChild(messages[messages.length - 1]);
      }
      stopRecognition();
    });
  </script>
</body>
</html>
